// Prisma Schema for 清水亭学校七（三）班级网站

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 管理员模型
model Admin {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String   // 使用 bcryptjs 加密存储
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  logs      OperationLog[]
}

// 公告模型
model Announcement {
  id          Int      @id @default(autoincrement())
  title       String
  content     String   // 富文本内容
  summary     String?  // 摘要
  isImportant Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 相册模型
model Album {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  coverImage  String?  // 封面图片URL
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  photos      Photo[]
}

// 照片模型
model Photo {
  id           Int      @id @default(autoincrement())
  albumId      Int
  url          String   // 原图URL
  thumbnailUrl String   // 缩略图URL
  caption      String?
  order        Int      @default(0)
  createdAt    DateTime @default(now())
  
  album        Album    @relation(fields: [albumId], references: [id], onDelete: Cascade)
}

// 成员模型
model Member {
  id        Int      @id @default(autoincrement())
  name      String
  role      String   // teacher, student
  position  String?  // 班主任、数学老师等
  avatar    String?
  bio       String?  // 简介
  specialty String?  // 特长
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 课程表模型
model Schedule {
  id        Int      @id @default(autoincrement())
  dayOfWeek Int      // 1-5 (周一到周五)
  period    Int      // 第几节课
  subject   String   // 科目
  teacher   String?  // 任课教师（可选）
  classroom String?  // 教室（可选）
  startTime String?  // 开始时间（可选）
  endTime   String?  // 结束时间（可选）
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([dayOfWeek, period])
}

// 作业模型
model Homework {
  id          Int       @id @default(autoincrement())
  date        DateTime  // 作业日期
  subject     String    // 科目
  content     String    // 作业内容
  deadline    DateTime? // 截止时间
  attachments String?   // 附件URL（JSON数组）
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// 荣誉模型
model Honor {
  id          Int      @id @default(autoincrement())
  title       String   // 荣誉名称
  description String?  // 描述
  date        DateTime // 获奖日期
  imageUrl    String?  // 奖状照片（保留兼容性）
  images      String?  // 多张图片（JSON数组）
  category    String?  // 分类
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 留言模型
model Message {
  id        Int      @id @default(autoincrement())
  nickname  String
  content   String
  createdAt DateTime @default(now())
}

// 操作日志模型
model OperationLog {
  id        Int      @id @default(autoincrement())
  adminId   Int
  action    String   // create, update, delete
  target    String   // announcement, album, etc.
  targetId  Int?
  details   String?
  createdAt DateTime @default(now())
  
  admin     Admin    @relation(fields: [adminId], references: [id])
}

// 班级信息模型（单例）
model ClassInfo {
  id           Int      @id @default(autoincrement())
  className    String   // 班级名称
  motto        String?  // 班级口号
  description  String?  // 班级介绍
  classPhoto   String?  // 班级集体照
  emblem       String?  // 班徽
  studentCount Int      @default(0)
  headTeacher  String?
  establishedYear String?
  contactEmail String?
  contactPhone String?
  updatedAt    DateTime @updatedAt
}

// 投票模型
model Poll {
  id          Int      @id @default(autoincrement())
  title       String   // 投票标题
  description String?  // 投票描述
  type        String   // single（单选）, multiple（多选）
  maxChoices  Int      @default(1) // 多选时最多可选几项
  startDate   DateTime @default(now())
  endDate     DateTime // 截止日期
  isActive    Boolean  @default(true)
  allowAnonymous Boolean @default(true) // 是否允许匿名投票
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  options     PollOption[]
  votes       Vote[]
}

// 投票选项模型
model PollOption {
  id        Int      @id @default(autoincrement())
  pollId    Int
  content   String   // 选项内容
  order     Int      @default(0)
  createdAt DateTime @default(now())
  
  poll      Poll     @relation(fields: [pollId], references: [id], onDelete: Cascade)
  votes     Vote[]
}

// 投票记录模型
model Vote {
  id        Int      @id @default(autoincrement())
  pollId    Int
  optionId  Int
  voterName String?  // 投票人姓名（匿名时为空）
  voterIp   String?  // IP地址（防止重复投票）
  createdAt DateTime @default(now())
  
  poll      Poll     @relation(fields: [pollId], references: [id], onDelete: Cascade)
  option    PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
}

// 资源分类模型
model ResourceCategory {
  id          Int      @id @default(autoincrement())
  name        String   @unique // 分类名称（如：语文、数学、英语）
  description String?  // 分类描述
  icon        String?  // 图标
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  resources   Resource[]
}

// 资源模型
model Resource {
  id          Int      @id @default(autoincrement())
  title       String   // 资源标题
  description String?  // 资源描述
  categoryId  Int      // 分类ID
  fileUrl     String   // 文件URL
  fileName    String   // 文件名
  fileSize    Int?     // 文件大小（字节）
  fileType    String?  // 文件类型（pdf, doc, ppt等）
  downloadCount Int    @default(0) // 下载次数
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  category    ResourceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  downloads   ResourceDownload[]
}

// 资源下载记录模型
model ResourceDownload {
  id         Int      @id @default(autoincrement())
  resourceId Int
  downloaderIp String? // 下载者IP
  createdAt  DateTime @default(now())
  
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
}
